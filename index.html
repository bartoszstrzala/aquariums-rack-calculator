<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Projektant Regału - Multi-Bay System FIXED</title>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #27ae60; --bg-color: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: var(--bg-color); color: var(--primary-color); overflow: hidden; }

        .sidebar {
            background: white;
            padding: 25px;
            width: 420px;
            min-width: 420px;
            max-width: 420px;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            height: 100vh;
            overflow-y: auto;
            box-sizing: border-box;
            z-index: 10;
        }

        .main-view {
            flex-grow: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .canvas-wrapper {
            flex-grow: 1;
            overflow: auto;
            background: #eee;
            padding: 80px;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
        }

        .input-group { margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        label { font-size: 14px; font-weight: 600; flex-grow: 1; }
        input, select { width: 100px; padding: 8px; border: 1px solid #dcdde1; border-radius: 4px; }
        .results-panel { margin-top: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid var(--accent-color); font-size: 14px; }
        button { width: 100%; padding: 15px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        canvas { background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); flex-shrink: 0; }
        h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid var(--bg-color); padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>Ustawienia Projektu</h3>
    <div class="input-group"><label>Dł. akwarium (mm)</label> <input type="number" id="tankL" value="400"></div>
    <div class="input-group"><label>Szer. akwarium (mm)</label> <input type="number" id="tankW" value="400"></div>
    <div class="input-group"><label>Wys. akwarium (mm)</label> <input type="number" id="tankH" value="400"></div>
    <div class="input-group"><label>Prześwit serwis (mm)</label> <input type="number" id="gap" value="200"></div>
    <div class="input-group"><label>Akwaria w rzędzie</label> <input type="number" id="tanksPerRow" value="6"></div>
    <div class="input-group"><label>Ilość poziomów</label> <input type="number" id="rowCount" value="2"></div>
    <div class="input-group"><label>Grubość kantówki (mm)</label> <input type="number" id="beamSize" value="45"></div>
    <div class="input-group"><label>Wys. od ziemi (mm)</label> <input type="number" id="bottomClearance" value="150"></div>
    <div class="input-group"><label>Luz całkowity (mm)</label> <input type="number" id="tolerance" value="30"></div>
    <div class="input-group">
        <label>Preferowana strona</label>
        <select id="heavierSide">
            <option value="left">Lewa dociążona</option>
            <option value="right">Prawa dociążona</option>
        </select>
    </div>
    <button onclick="uiController.update()">GENERUJ PROJEKT</button>
    <div id="cuttingList" class="results-panel"></div>
</div>

<div class="main-view">
    <div class="canvas-wrapper"><canvas id="rackCanvas"></canvas></div>
</div>

<script>
    class RackCalculator {
        constructor(p) {
            this.p = p;
            const totalTankL = p.tankL * p.tanksPerRow;
            const maxBay = 1100; // Max rozpiętość przęsła

            // Obliczamy liczbę przęseł
            this.bayCount = Math.ceil(totalTankL / maxBay);
            if (this.bayCount < 1) this.bayCount = 1;

            // Dystrybucja akwariów
            this.distribution = this.calculateDistribution(p.tanksPerRow, this.bayCount, p.heavierSide);

            // Szerokość każdego przęsła (światło)
            const tolPerBay = p.tolerance / this.bayCount;
            this.bayWidths = this.distribution.map(count => (count * p.tankL) + tolPerBay);

            // Szerokość całkowita
            this.totalW = this.bayWidths.reduce((a, b) => a + b, 0) + ((this.bayCount + 1) * p.beamSize);
            this.totalH = p.bottomClearance + (p.rowCount * (p.tankH + p.serviceGap + p.beamSize)) + p.beamSize;
        }

        calculateDistribution(total, bays, side) {
            let dist = new Array(bays).fill(Math.floor(total / bays));
            let rem = total % bays;
            if (side === 'left') {
                for (let i = 0; i < rem; i++) dist[i]++;
            } else {
                for (let i = bays - 1; i > bays - 1 - rem; i--) dist[i]++;
            }
            return dist;
        }
    }

    class RackRenderer {
        constructor(canvasId) {
            this.canvas = document.getElementById(canvasId);
            this.ctx = this.canvas.getContext('2d');
            this.scale = 0.5;
            this.offX = 100;
            this.offY = 80;
        }

        render(calc) {
            const p = calc.p; const s = this.scale;
            this.canvas.width = calc.totalW * s + 300;
            this.canvas.height = calc.totalH * s + 300;
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

            // 1. POZIOME
            this.ctx.fillStyle = "#8d6e63";
            const rowH = (p.tankH + p.serviceGap + p.beamSize);
            for (let i = 0; i <= p.rowCount; i++) {
                const y = this.offY + (calc.totalH - p.bottomClearance - p.beamSize - (i * rowH)) * s;
                this.ctx.fillRect(this.offX, y, calc.totalW * s, p.beamSize * s);
            }

            // 2. AKWARIA
            for (let i = 0; i < p.rowCount; i++) {
                const shelfY = this.offY + (calc.totalH - p.bottomClearance - p.beamSize - (i * rowH)) * s;
                const tankY = shelfY - (p.tankH * s);
                let curX = this.offX + (p.beamSize * s);
                for (let b = 0; b < calc.bayCount; b++) {
                    this.drawBay(curX, tankY, calc.distribution[b], p, calc.bayWidths[b]);
                    curX += (calc.bayWidths[b] + p.beamSize) * s;
                }
            }

            // 3. NOGI
            this.ctx.fillStyle = "#4a302a";
            let legX = this.offX;
            for (let b = 0; b <= calc.bayCount; b++) {
                this.ctx.fillRect(legX, this.offY, p.beamSize * s, calc.totalH * s);
                if (b < calc.bayCount) legX += (calc.bayWidths[b] + p.beamSize) * s;
            }

            this.drawAnnotations(calc);
        }

        drawBay(startX, y, count, p, bayW) {
            if (count === 0) return;
            const s = this.scale;
            const free = (bayW - (count * p.tankL)) * s;
            const start = startX + (free / 2);
            for (let j = 0; j < count; j++) {
                const ax = start + (j * p.tankL * s);
                this.ctx.fillStyle = "rgba(173, 216, 230, 0.7)";
                this.ctx.strokeStyle = "#004488";
                this.ctx.fillRect(ax + 2, y, (p.tankL * s) - 4, p.tankH * s);
                this.ctx.strokeRect(ax + 2, y, (p.tankL * s) - 4, p.tankH * s);
            }
        }

        drawAnnotations(calc) {
            const s = this.scale; const p = calc.p;
            const yB = this.offY + (calc.totalH - p.bottomClearance - p.beamSize) * s;
            this.drawArrow(this.offX - 70, this.offY, this.offX - 70, this.offY + calc.totalH * s, `${calc.totalH}mm`, "black");
            this.drawArrow(this.offX, this.offY + calc.totalH * s + 80, this.offX + calc.totalW * s, this.offY + calc.totalH * s + 80, `${calc.totalW}mm`, "black");
            let curX = this.offX + (p.beamSize * s);
            for (let b = 0; b < calc.bayCount; b++) {
                this.drawArrow(curX, yB + 40*s, curX + calc.bayWidths[b]*s, yB + 40*s, `${Math.round(calc.bayWidths[b])}mm`, "brown");
                curX += (calc.bayWidths[b] + p.beamSize) * s;
            }
        }

        drawArrow(x1, y1, x2, y2, label, color) {
            const ctx = this.ctx; const head = 10; const angle = Math.atan2(y2 - y1, x2 - x1);
            ctx.save(); ctx.strokeStyle = color; ctx.fillStyle = color; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
            const dh = (tx, ty, a) => {
                ctx.beginPath(); ctx.moveTo(tx, ty);
                ctx.lineTo(tx - head * Math.cos(a - 0.5), ty - head * Math.sin(a - 0.5));
                ctx.lineTo(tx - head * Math.cos(a + 0.5), ty - head * Math.sin(a + 0.5));
                ctx.fill();
            };
            dh(x2, y2, angle); dh(x1, y1, angle + Math.PI);
            ctx.fillStyle = "black"; ctx.font = "bold 12px Arial"; ctx.textAlign = "center";
            const mx = (x1 + x2) / 2; const my = (y1 + y2) / 2;
            ctx.save(); ctx.translate(mx, my); if(Math.abs(x1-x2)<2) ctx.rotate(-Math.PI/2);
            ctx.fillText(label, 0, -8); ctx.restore(); ctx.restore();
        }
    }

    const uiController = {
        update() {
            const p = {
                tankL: +document.getElementById('tankL').value, tankW: +document.getElementById('tankW').value,
                tankH: +document.getElementById('tankH').value, serviceGap: +document.getElementById('gap').value,
                tanksPerRow: +document.getElementById('tanksPerRow').value, rowCount: +document.getElementById('rowCount').value,
                beamSize: +document.getElementById('beamSize').value, bottomClearance: +document.getElementById('bottomClearance').value,
                tolerance: +document.getElementById('tolerance').value, heavierSide: document.getElementById('heavierSide').value
            };
            const calc = new RackCalculator(p);
            const renderer = new RackRenderer('rackCanvas');
            renderer.render(calc);
            const legPairs = calc.bayCount + 1;
            document.getElementById('cuttingList').innerHTML = `
            <strong>Lista Cięcia:</strong><br>
            • Liczba przęseł (Bays): ${calc.bayCount}<br>
            • Nogi (pion): ${legPairs * 2}x ${calc.totalH}mm<br>
            • Belki front/tył: ${(p.rowCount + 1) * 2}x ${calc.totalW}mm<br>
            • Poprzeczki: ${legPairs * (p.rowCount + 1)}x ${p.tankW + p.tolerance}mm
        `;
        }
    };
    window.onload = () => uiController.update();
</script>
</body>
</html>